#+STARTUP: overview

* Original memory map

As Ghouls is partly BASIC, the BASIC workspace as $400...$7ff is not
available.

26 pages GMC; 39 pages GBAS; 3 pages variables; 1 page BASIC stack.

UseOK indicates whether this region is OK for Ghouls to use in
practice.

Regarding pages marked as maybe useable, OS workspace:

- 0b :: F key definitions on B/B+, Econet stuff on Master
- 0c :: UDGs on B/B+, Econet stuff on Master

B/B+ DFS workspace:

- 11-16 :: DFS random access workspace on B/B+
- 17-18 :: DFS private workspace on B/B+

If not using random access files or changing FS, on B/B+ with DFS,
pages 11-18 are useable.

Not worth supporting non-DFS setups on B/B+.

On Master, PAGE is always $e00, so only page 0d is unusable.

| Page | What   | UseOK | Notes                                       |
|------+--------+-------+---------------------------------------------|
|   09 | GMC    | Yes   |                                             |
|   0a | GMC    |       |                                             |
|------+--------+-------+---------------------------------------------|
|   0b | GMC    | Maybe | Apparently unused                           |
|   0c | GMC    |       | OS 1.20 UDGs - read on startup              |
|------+--------+-------+---------------------------------------------|
|   0d | GMC    | No    |                                             |
|   0e | GMC    |       |                                             |
|   0f | GMC    |       |                                             |
|   10 | GMC    |       |                                             |
|------+--------+-------+---------------------------------------------|
|   11 | GMC    | Maybe |                                             |
|   12 | GMC    |       |                                             |
|   13 | GMC    |       |                                             |
|   14 | GMC    |       |                                             |
|   15 | GMC    |       |                                             |
|   16 | GMC    |       |                                             |
|   17 | GMC    |       |                                             |
|   18 | GMC    |       |                                             |
|------+--------+-------+---------------------------------------------|
|   19 | GMC    | Yes   |                                             |
|   1a | GMC    |       |                                             |
|   1b | GMC    |       |                                             |
|   1c | GMC    |       |                                             |
|   1d | GMC    |       |                                             |
|   1e | GMC    |       |                                             |
|   1f | GMC    |       |                                             |
|   20 | GMC    |       |                                             |
|   21 | GMC    |       |                                             |
|------+--------+-------+---------------------------------------------|
|   22 | GBAS   | Yes   |                                             |
|   23 | GBAS   |       |                                             |
|   24 | GBAS   |       |                                             |
|   25 | GBAS   |       |                                             |
|   26 | GBAS   |       |                                             |
|   27 | GBAS   |       |                                             |
|   28 | GBAS   |       |                                             |
|   29 | GBAS   |       |                                             |
|   2a | GBAS   |       |                                             |
|   2b | GBAS   |       |                                             |
|   2c | GBAS   |       |                                             |
|   2d | GBAS   |       |                                             |
|   2e | GBAS   |       |                                             |
|   2f | GBAS   |       |                                             |
|   30 | GBAS   |       |                                             |
|   31 | GBAS   |       |                                             |
|   32 | GBAS   |       |                                             |
|   33 | GBAS   |       |                                             |
|   34 | GBAS   |       |                                             |
|   35 | GBAS   |       |                                             |
|   36 | GBAS   |       |                                             |
|   37 | GBAS   |       |                                             |
|   38 | GBAS   |       |                                             |
|   39 | GBAS   |       |                                             |
|   3a | GBAS   |       |                                             |
|   3b | GBAS   |       |                                             |
|   3c | GBAS   |       |                                             |
|   3d | GBAS   |       |                                             |
|   3e | GBAS   |       |                                             |
|   3f | GBAS   |       |                                             |
|   40 | GBAS   |       |                                             |
|   41 | GBAS   |       |                                             |
|   42 | GBAS   |       |                                             |
|   43 | GBAS   |       |                                             |
|   44 | GBAS   |       |                                             |
|   45 | GBAS   |       |                                             |
|   46 | GBAS   |       |                                             |
|   47 | GBAS   |       |                                             |
|   48 | GBAS   |       |                                             |
|   49 | GBAS   |       |                                             |
|------+--------+-------+---------------------------------------------|
|   4a | BVars  | Yes   | Includes some slack space                   |
|   4b | BVars  |       |                                             |
|   4c | BVars  |       |                                             |
|------+--------+-------+---------------------------------------------|
|   4d | Spare  | Yes   |                                             |
|   4e | Spare  |       |                                             |
|   4f | Spare  |       |                                             |
|   50 | Spare  |       |                                             |
|   51 | Spare  |       |                                             |
|   52 | Spare  |       |                                             |
|   53 | Spare  |       |                                             |
|   54 | Spare  |       |                                             |
|   55 | Spare  |       |                                             |
|   56 | Spare  |       |                                             |
|------+--------+-------+---------------------------------------------|
|   57 | BStack | Yes   | Hopefully won't grow into the page below... |
|------+--------+-------+---------------------------------------------|
|   58 | Screen |       |                                             |
|  ... |        |       |                                             |
|   7f |        |       |                                             |
|------+--------+-------+---------------------------------------------|

Some notes:

- End of BASIC variables can be seen at $02/$03 (see
  http://8bs.com/basic/memory.htm)

- There's a few places now where strings are built up using `CHR$`,
  rather than just being a literal with embedded control codes. But I
  think such operations are performed in the string work area in page
  6? - so it's only the final length of the string that influences how
  much BASIC heap space is used. So the end result should be the same
  (or near enough)

* Available zero page

- $70...$8f :: BASIC workspace left free for user programs
- $a8...$af :: available between * commands (any * command might
  overwrite)
- $b0...$bf :: available between FS calls (any FS call might
  overwrite)

Possibly also available:

- $50...$70 :: not obviously used by any 6502 version of BBC BASIC, as
  far as I can tell - see
  https://github.com/tom-seddon/basic_editor/blob/0d88b6e3bf0290a4b62fc3ac48730a61e7d12f9b/basiced.s65#L99

* Level stuff

Level is a 20*25 grid. 

Top left is at (0,5)

UDGs used:

- 224 e0 :: block ||
- 225 e1 :: spring (upper)
- 226 e2 :: block \\
- 227 e3 :: block //
- 228 e4 :: spikes
- 229 e5 :: spring (lower)
- 243 f3 :: dots

Things that a level can contain:

| Thing      | Types | Max in level |
|------------+-------+--------------|
| Block      |     3 | -            |
| Spikes     |     1 | -            |
| Dots       |     1 | -            |
| Springs    |     2 | -            |
| Spider     |     1 | 1            |
| Platform   |     1 | 1            |
| Conveyor   |     1 | 1            |
| Power pill |     1 | -            |



Spider and platform have configurable speeds.

Start and end positions are currently fixed.

Coordinates are given as per PRINT TAB.

Fractional coordinates are possible for spiders, platforms, conveyors
and power pills, as they are positioned by screen address.

** SPECTRES' LAIR

| What     |  X |  Y | Condition |
|----------+----+----+-----------|
| Spike    |  7 | 23 |           |
| Pill     | 18 | 15 |           |
| Dots     |  7 | 27 |           |
| Dots     |  8 | 27 |           |
| Dots     |  9 | 27 |           |
| Dots     | 10 | 27 |           |
| Dots     | 11 | 27 |           |
| Dots     | 12 | 27 |           |
| Dots     |  9 | 22 |           |
| Dots     | 10 | 22 |           |
| Dots     | 11 | 22 |           |
| Dots     | 12 | 22 |           |
| Dots     | 13 | 22 |           |
| Dots     | 14 | 22 |           |
| Dots     |  1 |  4 |           |
| Dots     |  2 |  4 |           |
| Dots     |  6 |  4 |           |
| Dots     |  7 |  4 |           |
| Platform |  8 | 14 |           |
| PSpeed   |  6 |    |           |
| Spider   |  9 | 14 | GO>0      |
| SSpeed   |  8 |    | GO>0      |

#+begin_example
  --0001020304050607080910111213141516171819--
  05__________________________________\\||||05
  06||||//____\\||||||________||____________06
  07________________||____________||________07
  08__________________||||//________________08
  09__________________________||____________09
  10________________________________________10
  11____\\||||||||||//____\\||||||||||//____11
  12||______________________________________12
  13||||____________________________________13
  14____||__||__________________||__________14
  15____________________________||||________15
  16________________________________________16
  17__________________________________||||||17
  18__________||||______________||||||||||||18
  19__________________\\||||||||||||||||||||19
  20____||||________________________________20
  21||______________________________________21
  22||||____________________________________22
  23||||||__________________________________23
  24||||||||//__\\||||||||||||||||//________24
  25________________________________________25
  26__________________________________||||||26
  27________________________________||||||||27
  28____________________________||||||||||||28
  29||||||||||||||||||||||||||||||||||||||||29
  --0001020304050607080910111213141516171819--

#+end_example

** HORRID HALL

| What     |   X |  Y | Condition |
|----------+-----+----+-----------|
| Spikes   |   4 | 17 |           |
| Spring U |  17 | 26 |           |
| Spring L |  17 | 27 |           |
| Spikes   |  17 | 12 |           |
| Dots     |   6 | 11 |           |
| Dots     |   7 | 11 |           |
| Dots     |   8 | 11 |           |
| Dots     |   9 | 11 |           |
| Dots     |  10 | 11 |           |
| Dots     |  11 | 11 |           |
| Dots     |  12 | 11 |           |
| Dots     |  13 | 11 |           |
| Dots     |  14 | 11 |           |
| Dots     |  15 | 11 |           |
| Dots     |  11 | 17 |           |
| Dots     |  12 | 17 |           |
| Dots     |  13 | 17 |           |
| Dots     |  14 | 17 |           |
| Dots     |  15 | 17 |           |
| Dots     |  16 | 17 |           |
| Dots     |  17 | 17 |           |
| Platform |  14 |  7 |           |
| PSpeed   |  14 |    |           |
| Conveyor |  18 | 13 |           |
| Spider   | 0.5 | 12 | GO>0      |
| SSpeed   |   4 |    | GO>0      |
| Pill     |   1 | 23 |           |

#+begin_example
  --0001020304050607080910111213141516171819--
  05__________________________________\\||||05
  06________________________________________06
  07||____________________________________||07
  08________________________________________08
  09________\\||||||||||||||||||||||||______09
  10__________________________________||____10
  11________________________________________11
  12____________________________________||||12
  13__________||__________________________||13
  14______||||______________________________14
  15________________________________________15
  16||||____________________________________16
  17||||||__________________________________17
  18||||||||||||||//________________________18
  19____________________\\||||||||||||||||||19
  20________________________________________20
  21____________||||//______________________21
  22__________||||______________||||________22
  23________||||________\\||||||||__________23
  24______||||______________________________24
  25||||||||________________________________25
  26________________||||________||||||||||||26
  27__________________________||||||||||||||27
  28__________||||__________||||||||||||||||28
  29||||||||||||||||||||||||||||||||||||||||29
  --0001020304050607080910111213141516171819--
#+end_example

** SPIDERS PARLOUR

| What     |  X |  Y | Condition |
|----------+----+----+-----------|
| Spring U | 14 |  8 |           |
| Spikes   |  1 | 13 |           |
| Spikes   | 17 | 16 |           |
| Spikes   |  8 | 24 |           |
| Spikes   | 10 | 24 |           |
| Spikes   |  7 | 28 |           |
| Dots     | 13 |  9 |           |
| Dots     | 14 |  9 |           |
| Dots     | 15 |  9 |           |
| Dots     | 16 |  9 |           |
| Dots     | 17 |  9 |           |
| Dots     | 18 |  9 |           |
| Dots     |  9 | 15 |           |
| Dots     | 10 | 15 |           |
| Dots     | 11 | 15 |           |
| Dots     | 12 | 15 |           |
| Dots     | 13 | 15 |           |
| Dots     | 14 | 15 |           |
| Platform | 13 | 14 |           |
| PSpeed   |  5 |    |           |
| Conveyor | 18 | 17 |           |
| Spider   |  7 |  7 |           |
| SSpeed   | 12 |    |           |
| Pil      |  1 | 22 |           |

#+begin_example
  --0001020304050607080910111213141516171819--
  05__________________________________\\||||05
  06____________\\||||//____________________06
  07________________________________________07
  08__________________________||||||||______08
  09________________________________________09
  10______________________||________________10
  11____||||||||||||||||||||||||||||||||||||11
  12________________________________________12
  13||______________________________________13
  14||____________________________||||______14
  15________________________________________15
  16____________________________________||||16
  17____________||________________________||17
  18________________________________________18
  19______||||______________________________19
  20__________||____________________________20
  21____________||||________________________21
  22________________________________________22
  23__________________||||__________________23
  24||||||||________________________||||____24
  25________||||||||||||||||||||||||________25
  26______________________________________||26
  27____________________________________||||27
  28__________________||||____________||||||28
  29||||||||||||||||||||||||||||||||||||||||29
  --0001020304050607080910111213141516171819--
#+end_example

** DEATH TOWER

| What     |  X |  Y | Condition |
|----------+----+----+-----------|
| Spikes   |  2 |  7 |           |
| Spikes   |  5 |  7 |           |
| Spikes   |  8 |  7 |           |
| Spikes   |  9 | 17 |           |
| Spikes   | 15 | 17 |           |
| Spring U | 16 | 27 |           |
| Spring L | 16 | 28 |           |
| Dots     |  3 | 22 |           |
| Dots     |  4 | 22 |           |
| Dots     |  5 | 22 |           |
| Dots     |  6 | 22 |           |
| Dots     |  7 | 22 |           |
| Dots     |  8 | 22 |           |
| Dots     |  2 |  9 |           |
| Dots     |  3 |  9 |           |
| Dots     |  4 |  9 |           |
| Dots     |  5 |  9 |           |
| Dots     |  6 |  9 |           |
| Dots     |  7 |  9 |           |
| Dots     | 10 | 16 |           |
| Dots     | 11 | 16 |           |
| Dots     | 12 | 16 |           |
| Dots     | 13 | 16 |           |
| Platform |  9 | 15 |           |
| PSpeed   |  8 |    |           |
| Conveyor | 18 | 21 |           |
| Spider   |  6 | 25 |           |
| SSpeed   | 12 |    |           |
| Pill     |  2 | 17 |           |
| Pill     |  1 | 6  |           |

#+begin_example
  --0001020304050607080910111213141516171819--
  05__________________________________||||||05
  06________________________________________06
  07______________________________||________07
  08____||||||||||||||||||______||||________08
  09__________________________||____||______09
  10________________________||________||____10
  11||||__||____||____||__||________________11
  12__||||__||||__||||____________________||12
  13____________________________||||____||__13
  14__________________________||____||||____14
  15||____________________||||______________15
  16__||||__________________________________16
  17__________||____________________________17
  18____________||||||||||||||||||||||||____18
  19____||__________________________________19
  20______________________________________||20
  21||________||__________________________||21
  22__||____________________________________22
  23________________________________________23
  24______||||||||||||||______||||__________24
  25____________________||__________________25
  26||______________________________________26
  27||||__________________________||__||____27
  28||||||______________________||||__||||__28
  29||||||||||||||||||||||||||||||||||||||||29
  --0001020304050607080910111213141516171819--
#+end_example

* Level data format

** Header

| Offset | Type    | Name   | What                            |
|--------+---------+--------+---------------------------------|
|     +0 | byte[4] | ident  | bf d7 73 0e - file magic number |
|     +4 | dword   | level1 | offset of level 1 data          |
|     +8 | dword   | level2 | offset of level 2 data          |
|    +12 | dword   | level3 | offset of level 3 data          |
|   +116 | dword   | level4 | offset of level 4 data          |

The magic number is `&0e73d7bf` when read with BBC BASIC's `!`
operator.

Offsets are relative to the start of the file.

** Level data

| Offset | Type         | Name   | What                            |
|--------+--------------+--------+---------------------------------|
|     +0 | byte[26][20] | level  | Map data                        |
|   +520 | word         | name_x | Graphics X coord for level name |
|   +522 | char[16]     | name   | Level name                      |

The logic behind the name's X coordinate is a bit unclear. So if it
goes in the level data, original levels can match the originals for
now, and the editor can do something sensible for any new levels. It's
only 2 bytes.

** Map data

A 20 wide x 26 high grid of bytes. Bytes as follows:

| Value | What              | Flags? |
|-------+-------------------+--------|
|     0 | Blank             |        |
|     1 | Left Block        |        |
|     2 | Right Block       |        |
|     3 | Block             |        |
|     4 | Spikes            |        |
|     5 | Spring (upper)    |        |
|     6 | Spring (lower)    |        |
|     7 | Dots              |        |
|     8 | Pill              |        |
|     9 | Floating platform | y      |
|    10 | Conveyor          |        |
|    11 | Spider            | y      |

If the thing has flags, they are stored in the next byte. (Things with
flags are 16 pixels wide, so they'd occupy 2 bytes anyway.) The flag
bits are as follows:

:   7   6   5   4   3   2   1   0
: +---+---+---+---+---+---+---+---+
: | G | H |   | Speed             |
: +---+---+---+---+---+---+---+---+

~G~, if set, means the object only appears when there are multiple
ghosts.

~H~, if set, means the object has a half column offset applied -
moving it effectively 4 pixels to the left.

~Speed~ is the object's speed.

The unused bit is unused.
